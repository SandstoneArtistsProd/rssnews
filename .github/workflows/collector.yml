name: Deadline Collector - Scheduled Run

on:
  # Run on schedule (every hour)
  schedule:
    - cron: '0 * * * *'  # Every hour at :00 minutes
    # Cron syntax: minute hour day month day_of_week
    # Examples:
    # - cron: '*/30 * * * *'  # Every 30 minutes
    # - cron: '0 */2 * * *'   # Every 2 hours
    # - cron: '0 9 * * *'     # Daily at 9 AM UTC

  # Allow manual triggering
  workflow_dispatch:

  # Optional: Run on push to main (for testing)
  # push:
  #   branches: [ main ]

jobs:
  collect-articles:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download database from previous run
      uses: actions/download-artifact@v3
      with:
        name: articles-database
        path: .
      continue-on-error: true  # First run won't have a database

    - name: Run article collection
      run: |
        python collector.py
      env:
        PYTHONUNBUFFERED: 1

    - name: Show statistics
      run: |
        python collector.py --stats

    - name: Export to CSV
      run: |
        python collector.py --export --source Deadline

    - name: Upload database artifact
      uses: actions/upload-artifact@v3
      with:
        name: articles-database
        path: articles.db
        retention-days: 90  # Keep database for 90 days

    - name: Upload CSV exports
      uses: actions/upload-artifact@v3
      with:
        name: csv-exports-${{ github.run_number }}
        path: exports/*.csv
        retention-days: 30

    - name: Upload logs
      uses: actions/upload-artifact@v3
      if: always()  # Upload logs even if previous steps fail
      with:
        name: logs-${{ github.run_number }}
        path: logs/*.log
        retention-days: 7

  # Optional: Create a release with the latest export
  create-release:
    needs: collect-articles
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'  # Only on scheduled runs

    steps:
    - name: Download CSV exports
      uses: actions/download-artifact@v3
      with:
        name: csv-exports-${{ github.run_number }}
        path: exports

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: export-${{ steps.date.outputs.date }}
        name: Article Export - ${{ steps.date.outputs.date }}
        body: |
          Automated article collection and export
          Run #${{ github.run_number }}
          Date: ${{ steps.date.outputs.date }}
        files: exports/*.csv
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
